<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Route Details - Route Sense</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="shortcut icon" href="https://kavyaschool.edu.np/favicon.ico">
</head>

<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">

<header class="py-6 flex justify-center bg-white border-b border-slate-100 shadow-sm">
  <img src="https://kavyaschool.edu.np/images/Kavya-Ing.svg" class="h-12 w-auto" alt="Kavya Logo" />
</header>

<div class="max-w-4xl mx-auto px-4 pt-8">
  <a href="index.html" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-white border border-slate-200 text-slate-600 hover:border-slate-400 transition-all shadow-sm font-bold group">
    <i data-lucide="arrow-left" class="w-5 h-5 group-hover:-translate-x-1 transition-transform"></i> 
    Back to Home
  </a>
</div>

<main class="max-w-4xl mx-auto px-4 py-8">
  <div id="routeBox" class="bg-white rounded-[40px] shadow-2xl p-8 sm:p-12 border border-slate-50">
    <div class="flex flex-col items-center py-12">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#76c044] mb-4"></div>
      <p class="text-slate-400 font-medium">Fetching details...</p>
    </div>
  </div>
</main>

<script>
fetch("index.json")
  .then(r => r.json())
  .then(data => {
    const id = new URLSearchParams(location.search).get("id");
    const r = data[id];

    if (!r) {
      document.getElementById("routeBox").innerHTML = `
        <div class="text-center py-12">
          <i data-lucide="alert-octagon" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
          <h2 class="text-2xl font-black text-slate-900 mb-2">Route Not Found</h2>
          <p class="text-slate-500 mb-6">The route ID provided does not exist in our database.</p>
          <a href="index.html" class="text-[#76c044] font-bold underline">Go Back Home</a>
        </div>
      `;
      lucide.createIcons();
      return;
    }

    const schoolContactsHtml = r.school_contact.split(',').map(num => {
      const trimmedNum = num.trim();
      return `<a href="tel:${trimmedNum}" class="text-slate-900 font-bold hover:text-blue-600 hover:underline transition-colors">${trimmedNum}</a>`;
    }).join('<span class="text-slate-400 mx-1">,</span>');

    document.getElementById("routeBox").innerHTML = `
      <div class="space-y-10">
        <div>
          <p class="text-slate-400 font-bold uppercase tracking-widest text-xs mb-1">
            Kavya Shuttle Service
          </p>
          <h1 class="text-4xl font-black text-slate-900">Route ${id}: <span class="text-[#76c044]">${r.route_name}</span></h1>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 flex items-center gap-4">
            <div class="w-12 h-12 bg-white text-[#76c044] rounded-2xl flex items-center justify-center shadow-sm"><i data-lucide="user"></i></div>
            <div>
              <p class="text-xs font-bold text-slate-400 uppercase">Driver Name</p>
              <p class="text-xl font-black text-slate-800">${r.driver_name}</p>
            </div>
          </div>
          <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 flex items-center gap-4">
            <div class="w-12 h-12 bg-white text-blue-500 rounded-2xl flex items-center justify-center shadow-sm"><i data-lucide="phone"></i></div>
            <div>
              <p class="text-xs font-bold text-slate-400 uppercase">Driver Contact</p>
              <a href="tel:${r.driver_contact}" class="text-xl font-black text-blue-600 hover:underline transition-all">
                ${r.driver_contact}
              </a>
            </div>
          </div>
        </div>

        <div class="space-y-6">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <h2 class="text-2xl font-black text-slate-900 flex items-center gap-2">
               <i data-lucide="map-pin" class="text-red-500 w-6 h-6"></i> Scheduled Stops
            </h2>
            
            <button onclick="navigateToNearestStop()" class="inline-flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl font-bold text-sm transition-all shadow-lg shadow-blue-200">
              <i data-lucide="navigation" class="w-4 h-4"></i>
              Navigate to Nearest Stop
            </button>
          </div>

          <div id="navError" class="hidden p-3 bg-red-50 border border-red-100 text-red-600 text-sm font-medium rounded-xl"></div>

          <div class="bg-white border-2 border-slate-50 rounded-3xl divide-y-2 divide-slate-50 overflow-hidden shadow-sm">
            ${r.pickup_locations.map((l, index) => `
              <div class="px-6 py-5 hover:bg-slate-50 transition-colors flex items-center gap-4">
                <span class="w-8 h-8 flex-shrink-0 bg-slate-100 text-slate-500 rounded-lg flex items-center justify-center font-bold text-sm">${index + 1}</span>
                <p class="text-lg font-bold text-slate-700">${l.name}</p>
              </div>
            `).join("")}
          </div>
        </div>

        <div class="pt-8 border-t border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-6">
          <div class="flex items-center gap-3">
            <div class="p-2 bg-slate-100 rounded-lg text-slate-500">
              <i data-lucide="building" class="w-5 h-5"></i>
            </div>
            <div>
              <p class="text-xs font-bold uppercase tracking-wider text-slate-400">School Office</p>
              <div class="text-base">${schoolContactsHtml}</div>
            </div>
          </div>

          <a href="index.html" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 bg-[#76c044] hover:bg-[#68a93c] text-white px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-200 shadow-lg shadow-[#76c044]/20 hover:shadow-xl hover:-translate-y-1">
            <i data-lucide="search" class="w-5 h-5"></i>
            Search Another Route
          </a>
        </div>
      </div>
    `;
    lucide.createIcons();

    // Global function for navigation feature
    window.navigateToNearestStop = function() {
      const errorDiv = document.getElementById('navError');
      errorDiv.classList.add('hidden');

      if (!navigator.geolocation) {
        showNavError("Geolocation is not supported by your browser.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLat = position.coords.latitude;
          const userLon = position.coords.longitude;
          
          let nearestStop = null;
          let minDistance = Infinity;

          r.pickup_locations.forEach(loc => {
            const dist = calculateDistance(userLat, userLon, parseFloat(loc.latitude), parseFloat(loc.longitude));
            if (dist < minDistance) {
              minDistance = dist;
              nearestStop = loc;
            }
          });

          if (nearestStop) {
            // Using a 10km radius as a "reasonable" limit for shuttle stop search
            if (minDistance > 10) {
              showNavError("No shuttle stops found near your current location.");
              return;
            }
            
            // Open navigation in default maps app (Google/Apple Maps)
            const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${nearestStop.latitude},${nearestStop.longitude}&travelmode=driving`;
            window.open(mapUrl, '_blank');
          }
        },
        (error) => {
          showNavError("Turn on location to navigate to the nearest stop.");
        }
      );
    };

    function showNavError(msg) {
      const errorDiv = document.getElementById('navError');
      errorDiv.innerText = msg;
      errorDiv.classList.remove('hidden');
    }

    // Haversine formula to calculate distance in KM
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; 
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
  })
  .catch((err) => {
    console.error(err);
    document.getElementById("routeBox").innerHTML = `<p class="text-center text-red-500 font-bold">Error loading route.</p>`;
  });
</script>
</body>
<footer class="py-12 text-center text-slate-400 font-medium">
  Made with <span class="text-red-500">‚ù§</span> by 
  <span class="kavya-text text-sm">
    <span class="k-orange">K</span><span class="a-red">a</span><span class="v-blue">v</span><span class="y-green">y</span><span class="a-slate">a</span>
  </span> Students
</footer>
</html>